from fastapi import APIRouter, Depends, HTTPException
from sqlmodel import Session
import logging
from app.models.vulnerability import Vulnerability
from app.core.database import get_session
from app.core.security import get_current_user

router = APIRouter()

@router.delete("/{vuln_id}")
async def delete_vulnerability(
    vuln_id: int,
    current_user: dict = Depends(get_current_user),
    session: Session = Depends(get_session)
):
    """Elimina una vulnerabilidad cambiando su estado a 'deleted'"""
    # Verify user is admin
    if current_user.get("role") != "admin":
        raise HTTPException(
            status_code=403,
            detail="Only admins can delete vulnerabilities"
        )

    try:
        vuln = session.get(Vulnerability, vuln_id)

        if not vuln or vuln.status == "deleted":
            raise HTTPException(
                status_code=404,
                detail="Vulnerabilidad no encontrada"
            )

        vuln.status = "deleted"
        session.add(vuln)
        session.commit()

        return {"message": "Vulnerabilidad eliminada exitosamente", "id": vuln_id}

    except HTTPException as http_err:
        raise http_err
    except Exception as e:
        logging.error(f"Error inesperado: {str(e)}")
        raise HTTPException(status_code=500, detail="Error interno del servidor")
