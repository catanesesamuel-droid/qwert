from fastapi import APIRouter, Depends, HTTPException, status
from sqlmodel import Session, select
from app.models.vulnerability import Vulnerability
from app.core.database import get_session
from app.core.security import get_current_user
from app.models.vuln_schemas import VulnerabilityCreate, VulnerabilityResponse

router = APIRouter()

@router.post("/", response_model=VulnerabilityResponse, status_code=status.HTTP_201_CREATED)
async def create_vulnerability(
    vuln_data: VulnerabilityCreate,
    current_user: dict = Depends(get_current_user),
    session: Session = Depends(get_session)
):
    try:
        # Verify user is admin
        if current_user.get("role") != "admin":
            raise HTTPException(
                status_code=status.HTTP_403_FORBIDDEN,
                detail="Only admins can create vulnerabilities"
            )

        # Get user ID from database
        from app.models.user import User
        db_user = session.exec(
            select(User).where(User.username == current_user["username"])
        ).first()

        if not db_user:
            raise HTTPException(status_code=404, detail="User not found")

        # Check for duplicates
        existing = session.exec(
            select(Vulnerability).where(Vulnerability.name == vuln_data.name)
        ).first()

        if existing:
            raise HTTPException(status_code=400, detail="La vulnerabilidad ya existe")

        # Convert Severity enum to string value
        severity_value = vuln_data.severity.value if hasattr(vuln_data.severity, 'value') else str(vuln_data.severity)

        new_vuln = Vulnerability(
            name=vuln_data.name,
            description=vuln_data.description,
            severity=severity_value,
            created_by=db_user.id,  # Use authenticated user's ID
            status="active"
        )

        session.add(new_vuln)
        session.commit()
        session.refresh(new_vuln)

        return new_vuln

    except HTTPException:
        # Re-raise HTTP exceptions (403, 404, 400)
        raise
    except Exception as e:
        # Log the error and return a proper error message
        import traceback
        print(f"Error creating vulnerability: {str(e)}")
        print(traceback.format_exc())
        session.rollback()
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"Error al crear vulnerabilidad: {str(e)}"
        )
