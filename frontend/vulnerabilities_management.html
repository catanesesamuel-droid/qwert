<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n de Vulnerabilidades</title>
    <link rel="stylesheet" href="css/styles.css">
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: var(--bg-secondary);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .vulns-container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .vulns-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .vulns-header h2 {
            color: var(--text-primary);
            margin: 0;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
        }

        .btn-sm {
            padding: 5px 12px;
            font-size: 0.875rem;
        }

        .vulns-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .vuln-card {
            background: var(--bg-primary);
            border-radius: 8px;
            padding: 20px;
            box-shadow: var(--shadow-sm);
            border-left: 4px solid var(--primary-color);
            transition: transform 0.2s;
        }

        .vuln-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .vuln-card.critical {
            border-left-color: #dc3545;
        }

        .vuln-card.high {
            border-left-color: #fd7e14;
        }

        .vuln-card.medium {
            border-left-color: #ffc107;
        }

        .vuln-card.low {
            border-left-color: #17a2b8;
        }

        .vuln-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .vuln-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 5px;
        }

        .vuln-description {
            color: var(--text-secondary);
            font-size: 0.9rem;
            line-height: 1.5;
            margin-bottom: 15px;
        }

        .vuln-meta {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-critical {
            background: #dc3545;
            color: white;
        }

        .badge-high {
            background: #fd7e14;
            color: white;
        }

        .badge-medium {
            background: #ffc107;
            color: #000;
        }

        .badge-low {
            background: #17a2b8;
            color: white;
        }

        .vuln-actions {
            display: flex;
            justify-content: flex-end;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-primary);
            padding: 30px;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
            box-shadow: var(--shadow-lg);
        }

        .modal-content h3 {
            margin-top: 0;
            color: var(--text-primary);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: var(--text-primary);
            font-weight: 500;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-family: inherit;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            border: 1px solid #f5c6cb;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            border: 1px solid #c3e6cb;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <div class="vulns-container">
        <div class="vulns-header">
            <h2>üêõ Cat√°logo de Vulnerabilidades</h2>
            <div style="display: flex; gap: 10px; align-items: center;">
                <select id="severity-filter" class="form-group select" onchange="filterBySeverity()" style="padding: 10px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--bg-secondary); color: var(--text-primary);">
                    <option value="">Todas las severidades</option>
                    <option value="critical">Cr√≠tica</option>
                    <option value="high">Alta</option>
                    <option value="medium">Media</option>
                    <option value="low">Baja</option>
                </select>
                <button class="btn btn-success" onclick="openCreateModal()" id="btn-create">
                    ‚ûï Nueva Vulnerabilidad
                </button>
                <button class="btn btn-primary" onclick="refreshVulnerabilities()">
                    üîÑ Actualizar
                </button>
            </div>
        </div>

        <div id="message-container"></div>

        <div id="loading" class="loading" style="display: none;">
            ‚è≥ Cargando vulnerabilidades...
        </div>

        <div id="vulns-grid" class="vulns-grid">
            <!-- Las vulnerabilidades se cargar√°n aqu√≠ -->
        </div>

        <div id="empty-state" class="empty-state" style="display: none;">
            <i>üìã</i>
            <p>No hay vulnerabilidades registradas</p>
            <button class="btn btn-primary" onclick="openCreateModal()">
                Crear primera vulnerabilidad
            </button>
        </div>
    </div>

    <!-- Modal Crear Vulnerabilidad -->
    <div id="create-modal" class="modal">
        <div class="modal-content">
            <h3>‚ûï Nueva Vulnerabilidad</h3>
            <form id="create-form" onsubmit="createVulnerability(event)">
                <div class="form-group">
                    <label>Nombre *</label>
                    <input type="text" id="vuln-name" required minlength="1" maxlength="100" placeholder="Ej: SQL Injection">
                </div>
                <div class="form-group">
                    <label>Descripci√≥n * (m√≠nimo 10 caracteres)</label>
                    <textarea id="vuln-description" required minlength="10" maxlength="500" placeholder="Describe la vulnerabilidad..."></textarea>
                </div>
                <div class="form-group">
                    <label>Severidad *</label>
                    <select id="vuln-severity" required>
                        <option value="low">Baja</option>
                        <option value="medium">Media</option>
                        <option value="high">Alta</option>
                        <option value="critical">Cr√≠tica</option>
                    </select>
                </div>
                <div class="modal-buttons">
                    <button type="button" class="btn" onclick="closeCreateModal()">Cancelar</button>
                    <button type="submit" class="btn btn-success">Crear</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_BASE = '';

        // Obtener token y usuario del sessionStorage (funciona tanto en iframe como standalone)
        function getAuthData() {
            try {
                let user = null;

                // Intentar obtener del parent primero (si est√° en iframe)
                try {
                    if (window.parent !== window) {
                        user = JSON.parse(parent.sessionStorage.getItem('user'));
                    }
                } catch (e) {
                    // Ignorar errores de CORS
                }

                // Si no hay usuario del parent, usar sessionStorage local
                if (!user) {
                    user = JSON.parse(sessionStorage.getItem('user'));
                }

                if (!user || !user.token) {
                    console.warn('No hay usuario autenticado, redirigiendo al login...');
                    window.location.href = 'index.html';
                    return {};
                }

                // VERIFICACI√ìN DE ADMIN: Solo los administradores pueden acceder a esta p√°gina
                if (user.role !== 'admin') {
                    console.warn('Acceso denegado: Solo administradores pueden gestionar vulnerabilidades');
                    alert('‚ö†Ô∏è Acceso Denegado\n\nSolo los administradores pueden acceder a la gesti√≥n de vulnerabilidades.');
                    window.location.href = 'dashboard.html';
                    return {};
                }

                return {
                    token: user.token,
                    role: user.role,
                    userId: user.id
                };
            } catch (error) {
                console.error('Error obteniendo datos de auth:', error);
                window.location.href = 'index.html';
                return {};
            }
        }

        // Verificar si es admin
        function isAdmin() {
            const { role } = getAuthData();
            return role === 'admin';
        }

        // Mostrar/ocultar bot√≥n crear seg√∫n rol
        function updateUI() {
            const btnCreate = document.getElementById('btn-create');
            if (!isAdmin()) {
                btnCreate.style.display = 'none';
            }
        }

        // Mostrar mensaje
        function showMessage(message, type = 'success') {
            const container = document.getElementById('message-container');
            container.innerHTML = `
                <div class="${type}-message">
                    ${message}
                </div>
            `;
            setTimeout(() => {
                container.innerHTML = '';
            }, 3000);
        }

        // Cargar vulnerabilidades
        async function loadVulnerabilities(severity = '') {
            console.log('[vuln_management] Iniciando carga de vulnerabilidades...');
            const loading = document.getElementById('loading');
            const grid = document.getElementById('vulns-grid');
            const emptyState = document.getElementById('empty-state');
            const { token } = getAuthData();

            console.log('[vuln_management] Token obtenido:', token ? 'S√≠' : 'No');

            if (!token) {
                console.error('[vuln_management] No hay token disponible');
                showMessage('No hay sesi√≥n activa', 'error');
                return;
            }

            loading.style.display = 'block';
            grid.innerHTML = '';
            emptyState.style.display = 'none';

            try {
                let url = `${API_BASE}/stats/vulnerabilidades/`;
                if (severity) {
                    url += `?severity=${severity}`;
                }

                console.log('[vuln_management] Realizando petici√≥n a:', url);
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include'
                });

                console.log('[vuln_management] Respuesta recibida:', response.status, response.statusText);

                if (!response.ok) {
                    throw new Error(`Error al cargar vulnerabilidades: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                console.log('[vuln_management] Datos recibidos:', data);
                const vulnerabilities = data.vulnerabilities || [];
                console.log('[vuln_management] Vulnerabilidades:', vulnerabilities.length);

                if (vulnerabilities.length === 0) {
                    emptyState.style.display = 'block';
                } else {
                    grid.innerHTML = vulnerabilities.map(vuln => {
                        const nameEscaped = escapeHtml(vuln.name);
                        const descEscaped = escapeHtml(vuln.description);
                        const nameForJs = nameEscaped.replace(/'/g, "\\'");

                        // Formatear fecha de creaci√≥n
                        const createdDate = vuln.created_at ? new Date(vuln.created_at).toLocaleDateString('es-ES', {
                            year: 'numeric',
                            month: 'short',
                            day: 'numeric'
                        }) : '';

                        return `
                        <div class="vuln-card ${vuln.severity}">
                            <div class="vuln-header">
                                <div class="vuln-title">${nameEscaped}</div>
                                <span class="badge" style="background: #6c757d; color: white; font-size: 0.7rem;">#${vuln.id}</span>
                            </div>
                            <div class="vuln-description">${descEscaped}</div>
                            <div class="vuln-meta">
                                <span class="badge badge-${vuln.severity}">
                                    ${vuln.severity.toUpperCase()}
                                </span>
                                ${createdDate ? `<span class="badge" style="background: #6c757d; color: white;">üìÖ ${createdDate}</span>` : ''}
                            </div>
                            ${isAdmin() ? `
                                <div class="vuln-actions">
                                    <button class="btn btn-danger btn-sm" onclick="deleteVulnerability(${vuln.id}, '${nameForJs}')">
                                        üóëÔ∏è Eliminar
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    `;
                    }).join('');
                }

            } catch (error) {
                console.error('Error:', error);
                showMessage('Error al cargar vulnerabilidades: ' + error.message, 'error');
            } finally {
                loading.style.display = 'none';
            }
        }

        // Escapar HTML para prevenir XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Filtrar por severidad
        function filterBySeverity() {
            const severity = document.getElementById('severity-filter').value;
            loadVulnerabilities(severity);
        }

        // Abrir modal
        function openCreateModal() {
            if (!isAdmin()) {
                showMessage('Solo los administradores pueden crear vulnerabilidades', 'error');
                return;
            }
            document.getElementById('create-modal').classList.add('active');
        }

        // Cerrar modal
        function closeCreateModal() {
            document.getElementById('create-modal').classList.remove('active');
            document.getElementById('create-form').reset();
        }

        // Crear vulnerabilidad
        async function createVulnerability(event) {
            event.preventDefault();

            const { token } = getAuthData();
            if (!token) {
                showMessage('No hay sesi√≥n activa', 'error');
                return;
            }

            const name = document.getElementById('vuln-name').value;
            const description = document.getElementById('vuln-description').value;
            const severity = document.getElementById('vuln-severity').value;

            try {
                console.log('[vuln_management] Creando vulnerabilidad:', { name, description, severity });
                const response = await fetch(`${API_BASE}/stats/vulnerabilidades/`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        name,
                        description,
                        severity
                    })
                });

                console.log('[vuln_management] Respuesta al crear:', response.status, response.statusText);

                if (!response.ok) {
                    let errorMessage = `Error al crear vulnerabilidad: ${response.status}`;

                    // Intentar parsear error como JSON si es posible
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        try {
                            const error = await response.json();
                            errorMessage = error.detail || errorMessage;
                        } catch (e) {
                            console.error('[vuln_management] Error parseando JSON:', e);
                        }
                    } else {
                        const text = await response.text();
                        console.error('[vuln_management] Error del servidor:', text);
                    }

                    throw new Error(errorMessage);
                }

                showMessage('‚úÖ Vulnerabilidad creada exitosamente', 'success');
                closeCreateModal();
                loadVulnerabilities();
            } catch (error) {
                console.error('Error:', error);
                showMessage('Error: ' + error.message, 'error');
            }
        }

        // Eliminar vulnerabilidad
        async function deleteVulnerability(id, name) {
            if (!confirm(`¬øEliminar vulnerabilidad "${name}"?`)) {
                return;
            }

            const { token } = getAuthData();
            if (!token) {
                showMessage('No hay sesi√≥n activa', 'error');
                return;
            }

            try {
                console.log('[vuln_management] Eliminando vulnerabilidad ID:', id);
                const response = await fetch(`${API_BASE}/stats/vulnerabilidades/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include'
                });

                console.log('[vuln_management] Respuesta al eliminar:', response.status);

                if (!response.ok) {
                    let errorMessage = `Error al eliminar vulnerabilidad: ${response.status}`;

                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        try {
                            const error = await response.json();
                            errorMessage = error.detail || errorMessage;
                        } catch (e) {
                            console.error('[vuln_management] Error parseando JSON:', e);
                        }
                    }

                    throw new Error(errorMessage);
                }

                showMessage(`‚úÖ Vulnerabilidad "${name}" eliminada`, 'success');
                loadVulnerabilities();
            } catch (error) {
                console.error('Error:', error);
                showMessage('Error: ' + error.message, 'error');
            }
        }

        // Refrescar
        function refreshVulnerabilities() {
            const severity = document.getElementById('severity-filter').value;
            loadVulnerabilities(severity);
        }

        // Inicializar
        updateUI();
        loadVulnerabilities();

        // Cerrar modal al hacer click fuera
        document.getElementById('create-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeCreateModal();
            }
        });
    </script>
</body>
</html>
